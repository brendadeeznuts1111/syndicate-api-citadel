#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ›¡ï¸ Enhanced Runtime Gate - Pre-commit Validation"
echo "==============================================="

# Run critical runtime tests before allowing commit
echo "ğŸ” Running enhanced runtime validation..."

# Timezone matrix (quick check)
if ! bun test test/tz-matrix.test.ts > /dev/null 2>&1; then
    echo "âŒ Timezone matrix test failed"
    exit 1
fi

# Memory leak detection
if ! bun test test/memory.test.ts > /dev/null 2>&1; then
    echo "âŒ Memory leak detection failed"
    exit 1
fi

# Async leak detection
if ! bun test test/async-leak.test.ts > /dev/null 2>&1; then
    echo "âŒ Async leak detection failed"
    exit 1
fi

# Source map integrity
if ! bun test test/sourcemap.test.ts > /dev/null 2>&1; then
    echo "âŒ Source map integrity check failed"
    exit 1
fi

# Quick traceability check
if ! bun run audit:ci > /dev/null 2>&1; then
    echo "âŒ Traceability audit failed"
    exit 1
fi

echo "âœ… All enhanced runtime checks passed!"
echo "ğŸš€ Commit approved - runtime integrity maintained"
